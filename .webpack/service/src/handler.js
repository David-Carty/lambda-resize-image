!function(e,t){for(var n in t)e[n]=t[n]}(exports,function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n.w={},n(n.s=7)}([function(e,t){e.exports=require("aws-sdk")},function(e,t){e.exports=require("url")},function(e,t){e.exports=require("fs")},function(e,t,n){var r=new(n(0).S3)({signatureVersion:"v4"}),o=n(2),i=new RegExp("(.*)/(.*)"),c=process.env,a=c.BUCKET,u=c.URL;t.resizeCallback=function(e,t,n,i){return new Promise(function(c,s){e?s({statusCode:e.code,headers:{"X-Error":e||null},body:JSON.stringify(e)}):r.putObject({Bucket:a,Body:o.readFileSync(i),ContentType:t,Key:n},function(e){if(e)return s(e);o.unlink(i,function(){return console.log("INFO: Resized file cleaned up")}),c({statusCode:301,headers:{Location:"".concat(u,"/").concat(n)}})})})},t.generateS3Key=function(e,t){var n=i.exec(e),r=n[1]||"",o=n[2],c=t.width||"AUTO",a=t.height||"AUTO";return"".concat(r,"/").concat(c,"x").concat(a,"/").concat(o)}},function(e,t){e.exports=require("os")},function(e,t){e.exports=require("imagemagick")},function(e,t,n){var r=this,o=new(n(0).S3)({signatureVersion:"v4"}),i=n(5),c=n(4),a=n(3),u=a.resizeCallback,s=a.generateS3Key,d=process.env,h=d.BUCKET,f=d.URL;t.getImage=function(e){return new Promise(function(t,n){return o.getObject({Bucket:h,Key:e},function(r){if(r)return n(r);t({statusCode:301,headers:{Location:"".concat(f,"/").concat(e)}})})})},t.checkKeyExists=function(e,t){return new Promise(function(n,i){return o.headObject({Bucket:h,Key:s(e,t)},function(o){if(o&&"NotFound"===o.code)return r.resizeImage(e,t).then(n).catch(i);n({statusCode:301,headers:{Location:"".concat(f,"/").concat(s(e,t))}})})})},t.resizeImage=function(e,t){return new Promise(function(n,r){return o.getObject({Bucket:h,Key:e},function(o,a){if(o)return r(o);var d="".concat(c.tmpDir,"/resized.").concat(h,".").concat(t.width,".").concat(t.height);isNaN(t.height)?i.resize({width:t.width,srcData:a.Body,dstPath:d},function(r){return n(u(r,a.ContentType,s(e,t),d))}):i.crop({width:t.width,height:t.height,srcData:a.Body,dstPath:d,quality:1,gravity:"Center"},function(r){return n(u(r,a.ContentType,s(e,t),d))})})})}},function(e,t,n){var r=n(6),o=r.resizeImage,i=r.getImage,c=r.checkKeyExists,a=n(1),u=process.env,s=u.BUCKET,d=u.URL,h=1800,f=1800;e.exports.imageprocess=function(e,t,n){var r=e.queryStringParameters||{},u=e.path,l=a.parse(u).pathname.replace(/^\//g,"");if(!s||!d)return n(null,{statusCode:404,headers:{},body:"Error: Set environment variables BUCKET and URL.",isBase64Encoded:!1});var p={width:"AUTO"===r.width?null:parseInt(r.width),height:"AUTO"===r.height?null:parseInt(r.height)};return p.width>h||p.height>f?n(null,{statusCode:403,headers:{},body:"Error: Image size not permited.",isBase64Encoded:!1}):r.width||r.height?p.width?c(l,p):p.width?o(l,p).catch(function(e){return n(e)}):n(null,{statusCode:403,headers:{},body:"The parameter width is a required field to resize.",isBase64Encoded:!1}):i(l).catch(function(e){return n(e)})}}]));