!function(e,t){for(var n in t)e[n]=t[n]}(exports,function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n.w={},n(n.s=7)}([function(e,t){e.exports=require("aws-sdk")},function(e,t){e.exports=require("url")},function(e,t){e.exports=require("fs")},function(e,t,n){var r=new(n(0).S3)({signatureVersion:"v4"}),i=n(2),o=new RegExp("(.*)/(.*)"),c=process.env,u=c.BUCKET,a=c.URL;t.resizeCallback=function(e,t,n,o){return new Promise(function(c,s){e?s({statusCode:e.code,headers:{"X-Error":e||null},body:JSON.stringify(e)}):r.putObject({Bucket:u,Body:i.readFileSync(o),ContentType:t,Key:n},function(e){if(e)return s(e);i.unlink(o,function(){return console.log("INFO: Resized file cleaned up")}),c({statusCode:301,headers:{Location:"".concat(a,"/").concat(n)}})})})},t.generateS3Key=function(e,t){var n=o.exec(e),r=n[1]||"",i=n[2],c=t.width||"AUTO",u=t.height||"AUTO";return"".concat(r,"/").concat(c,"x").concat(u,"/").concat(i)}},function(e,t){e.exports=require("os")},function(e,t){e.exports=require("imagemagick")},function(e,t,n){var r=this,i=new(n(0).S3)({signatureVersion:"v4"}),o=n(5),c=n(4),u=n(3),a=u.resizeCallback,s=u.generateS3Key,h=process.env,f=h.BUCKET,d=h.URL;t.getImage=function(e){return new Promise(function(t,n){return i.getObject({Bucket:f,Key:e},function(r){if(r)return n(r);t({statusCode:301,headers:{Location:"".concat(d,"/").concat(e)}})})})},t.checkKeyExists=function(e,t){return new Promise(function(n,o){return i.headObject({Bucket:f,Key:s(e,t)},function(i){if(i&&"NotFound"===i.code)return r.resizeImage(e,t).then(n).catch(o);n({statusCode:301,headers:{Location:"".concat(d,"/").concat(s(e,t))}})})})},t.resizeImage=function(e,t){return new Promise(function(n,r){return i.getObject({Bucket:f,Key:e},function(i,u){if(i)return r(i);var h="".concat(c.tmpDir,"/resized.").concat(f,".").concat(t.width,".").concat(t.height);isNaN(t.height)?o.resize({width:t.width,srcData:u.Body,dstPath:h},function(r){return n(a(r,u.ContentType,s(e,t),h))}):o.crop({width:t.width,height:t.height,srcData:u.Body,dstPath:h,quality:1,gravity:"Center"},function(r){return n(a(r,u.ContentType,s(e,t),h))})})})}},function(e,t,n){var r=n(6),i=r.resizeImage,o=r.getImage,c=r.checkKeyExists,u=n(1),a=process.env,s=a.BUCKET,h=a.URL;e.exports.imageprocess=function(e){return new Promise(function(t,n){var r=e.queryStringParameters||{},a=e.path,f=u.parse(a).pathname.replace(/^\//g,"");if(!s||!h)return n("Error: Set environment variables BUCKET and URL.");var d={width:"AUTO"===r.width?null:parseInt(r.width),height:"AUTO"===r.height?null:parseInt(r.height)};return r.width||r.height?d.width?c(f,d).then(t):d.width?i(f,d).then(t).catch(n):n("The parameter width is a required field to resize."):o(f).then(t).catch(n)})}}]));